# guides-api

üìó Back-end for [Ekaterinburg guides website](https://github.com/ekaterinburgdev/guides) using Python Django & PostgreSQL.

The application caches content from Notion via Notion API into PostgreSQL database.

**[guides-api.ekaterinburg.city](https://guides-api.ekaterinburg.city)**

## API

### Pages tree
Returns tree of all page urls

```sh
https://guides-api.ekaterinburg.city/api/tree
```

### Get page
Returns page content

```sh
# Section
https://guides-api.ekaterinburg.city/api/content/street-name-plates

# Section + Page
https://guides-api.ekaterinburg.city/api/content/street-name-plates/general-provisions
```

- `street-name-plates` ‚Äî section name
- `general-provisions` ‚Äî page name


### Search
Search pages by query

```sh
https://guides-api.ekaterinburg.city/api/search?pattern=—Å–∫–∞–º—å—è
```
- `—Å–∫–∞–º—å—è` ‚Äî search query


## Debug API

> TODO: describe `dbretrieve` & `dbchildren` methods

Methods for raw Notion data debugging

### Get page Notion raw metadata


```sh
https://guides-api.ekaterinburg.city/api/test/retrieve?id=5604e0725f794708b9094b7ce49a46f7
```
- `5604e0725f794708b9094b7ce49a46f7` ‚Äî Notion page id

### Get page Notion raw content
```sh
https://guides-api.ekaterinburg.city/api/test/children?id=5604e0725f794708b9094b7ce49a46f7
```
- `5604e0725f794708b9094b7ce49a46f7` ‚Äî Notion page id

## Telegram bot commands
The site is managed via a telegram bot

`/update` ‚Äî update content

`/update -f` ‚Äî force update (rebuild tree, reload images, etc.)

## Development

1. Install [Docker](https://docs.docker.com/get-docker/)


2. Create `manuals/.env` file from [`manuals/.env.example`](https://github.com/ekaterinburgdev/guides-api/blob/main/manuals/.env.example) with secrets
- Notion token
- Django settings
- PostgreSQL settings
- Telegram (bot token from [@BotFather](https://telegram.me/BotFather) + master chat id from [@userinfobot](https://t.me/userinfobot)).


3. _(only first time)_ Create static volume folder
> TODO: create folder automatically in project folder (the folder path must be contained in `.gitignore`)
```sh
mkdir /usr/local/docker/manuals-static-volume/
```


4. _(only first time)_ Run database migrations
```sh
docker compose exec manuals python manage.py migrate
```

5. Run Django & Telegram bot
```sh
docker compose up -d --build
```

6. _(only first time)_ Send message to Telegram bot to force update
```
`/update -f`
```

<br />

## Updates 15.04.2022

> TODO: Translate to English, remove deprecated descriptions

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É —Å—Ç–∞—Ä–∞—è. –í–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª volume. –ß—Ç–æ–±—ã –≤—Å—ë —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–±–∏–ª–¥–∏–ª–æ—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Ö–æ—Ç—è –±—ã –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–∏–ª–¥ —Å —Ñ–ª–∞–≥–∞–º–∏:


### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

- –¢–µ–ø–µ—Ä—å –ø–æ–º–∏–º–æ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –µ—Å—Ç—å —Ç–∏–ø–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è –ø–æ –ø—É—Ç–∏ baseurl/api/content?id={page_id}
- –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ –ø—É—Ç–∏ baseurl/api/options
- –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ –ø–æ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –∏ –ª—é–±–æ–≥–æ –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ —Ç–æ–º—É –∂–µ –ø—É—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è id —ç–ª–µ–º–µ–Ω—Ç–∞. –í –Ω–∏—Ö —Ç–∞–∫ –∂–µ –±—É–¥—É—Ç –≤–ª–æ–∂–µ–Ω—ã –≤—Å–µ –∏—Ö –¥–µ—Ç–∏
- –ò–∑–º–µ–Ω–∏–ª—Å—è —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ baseurl/api/content. –¢–µ–ø–µ—Ä—å –æ–Ω –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫: { "{element_id}" : { "type" : "{element_tupe}", content : "{–∫–æ–Ω—Ç–µ–Ω—Ç —Å–∞–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞*}", children : [{—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–º–æ–∫ —Ç–æ–≥–æ –∂–µ —Ñ–æ—Ä–º–∞—Ç–∞}, ...]** } }
- –ü–æ –ø—Ä–æ—Å—å–±–µ –õ—å–≤–∞ –µ—Å—Ç—å —Ä—É—á–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —Å –Ω–æ—É—à–µ–Ω–∞, –Ω–æ –æ–Ω–∏ —É –º–µ–Ω—è –∏–∑ –¥–æ–∫–µ—Ä–∞ –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å. –ü–æ–∑–∂–µ —Ä–∞–∑–±–µ—Ä—É—Å—å. –ú–æ–∂–µ—Ç —É –≤–∞—Å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:
    - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∞–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ baseurl/api/test/retrieve?id={page_id}
    - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Ç–æ–º–∫–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–∞ baseurl/api/test/children?id={page_id}

–û–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–æ—É—à–µ–Ω–∞ (–ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ —Ç–µ—Ö, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ç–∏–ø–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ) –æ—á–µ–Ω—å –º–Ω–æ–≥–æ (–ø–æ—Ä—è–¥–∫–∞ 26), –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∂–¥–æ–π —è –Ω–µ —É—Å–ø–µ–ª. –ü–æ—ç—Ç–æ–º—É, –µ—Å–ª–∏ –≤ –∫–∞–∫–æ–º-—Ç–æ —ç–ª–µ–º–µ–Ω—Ç–µ –ª–µ—Ç–∏—Ç –º–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞, –∞ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ - —Å–æ–æ–±—â–∏—Ç–µ, –±—É–¥—É —Ä–∞–∑–±–∏—Ä–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –∏ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ–ª–µ–∑–Ω–æ. –ê –ø–æ–∫–∞ —á—Ç–æ –≤ content –ª–µ–∂–∏—Ç –ø–æ—á—Ç–∏ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —ç–ª–µ–º–µ–Ω—Ç–∞.

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ç–∏–ø–∞ image –ª–µ–∂–∏—Ç json —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏–∑ –Ω–æ—É—à–µ–Ω–∞ –ø–æ –∫–ª—é—á—É "image_data" (–æ—Å—Ç–∞–≤–∏–ª, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–º –ª–µ–∂–∞—Ç –ø–æ–¥–ø–∏—Å–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å), –∞ –ø–æ –∫–ª—é—á—É "image_name" –ª–µ–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –µ—ë —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫–æ–ø–∏–∏ –ø–æ –ø—É—Ç–∏ baseurl/static/{image_name}

–ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ç–∏–ø–∞–º, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∫—É. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –≤—ã—à–µ.

*–≠–ª–µ–º–µ–Ω—Ç—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –¥–µ—Ç–µ–π —Ç–æ–∂–µ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Å–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç. –ü—Ä–∏–º–µ—Ä - —Å–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏–π—Å—è —Å–ø–∏—Å–æ–∫ (—Ç–∏–ø "toggle"), –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –Ω–∞–¥–ø–∏—Å—å, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ø–∞–¥–µ—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç, –ø—Ä–∏ —ç—Ç–æ–º –∏–º–µ–µ—Ç –¥–µ—Ç–µ–π - —ç–ª–µ–º–µ–Ω—Ç—ã —Å–≤–æ—Ä–∞—á–∏–≤–∞—é—â–µ–≥–æ—Å—è —Å–ø–∏—Å–∫–∞.

**–ï—Å–ª–∏ –ø–æ—Ç–æ–º–∫–æ–≤ –Ω–µ—Ç, —Ç–æ —Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –ø—É—Å—Ç–æ–π - []

## Deprecated

–ü–µ—Ä–µ–¥ –±–∏–ª–¥–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –≥–¥–µ –ª–µ–∂–∏—Ç .env.example. –í —ç–∫–∑–∞–º–ø–ª–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å. –ó–∞ –∫–ª—é—á–æ–º –æ—Ç –¥–∂–∞–Ω–≥–∏ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫–æ –º–Ω–µ (–ï–≤–≥–µ–Ω–∏–π).

–ë–∏–ª–¥ –æ–±—Ä–∞–∑–∞: 
``` bash
docker-compose build
```

–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
``` bash
docker-compose up -d
```

–ß—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ë–î (–ø–æ–∫–∞ —á—Ç–æ. –ü–æ–∑–∂–µ —Å–¥–µ–ª–∞—é, —á—Ç–æ–±—ã –≤—Å—ë —Å–∞–º–æ —Ä–∞–±–æ—Ç–∞–ª–æ). –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
``` bash
docker-compose exec manuals python manage.py migrate
docker-compose exec manuals python manage.py init_db_check
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–æ–∏—Ç –≤–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç 48655

~~–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: baseurl/api/content~~

–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ id: baseurl/static/{pageid}

pageid –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–æ–≤—ã–π id.png

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ë–î, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∫—É. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É–ø–µ—Ä—é–∑–µ—Ä–∞, –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
``` bash
docker-compose exec manuals python manage.py createsuperuser 
```
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏–Ω, –º–µ–π–ª –∏ –ø–∞—Ä–æ–ª—å. –ú–æ–∂–Ω–æ –ª—é–±—ã–µ
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∫—É: baseurl/admin/
(—Å–ª—ç—à –≤ –∫–æ–Ω—Ü–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—á–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –í–≤–æ–¥–∏—Ç–µ —Å–≤–æ–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–∞–ø–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—É–ø–µ—Ä—é–∑–µ—Ä–∞

–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: 
``` bash
docker-compose down
```
